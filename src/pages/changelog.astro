---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';

const mdFiles = import.meta.glob('../changelogs/*.md', { eager: true }) as Record<string, any>;
const entries = Object.values(mdFiles).sort(
  (a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime()
);

function formatDate(dateStr: string) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
---

<Layout title="Changelog — Glasshouse">
  <Navbar />
  <main class="pt-20">
    <section class="px-6 py-24">
      <div class="mx-auto max-w-3xl">
        <h1 class="text-3xl font-bold tracking-tight text-text-primary sm:text-4xl">
          Platform updates
        </h1>
        

        <div class="relative mt-16 pl-8">
          <!-- Timeline line -->
          <div class="absolute left-[7px] top-2 bottom-0 w-px bg-border"></div>

          {entries.map((entry) => (
            <div class="relative mb-12 last:mb-0">
              <!-- Timeline dot -->
              <div class="absolute -left-8 top-1.5 h-[14px] w-[14px] rounded-full border-2 border-accent bg-bg"></div>

              <!-- Card -->
              <div class="rounded-lg border border-border bg-bg-card p-6">
                <div class="flex flex-wrap items-center gap-3">
                  <span class="font-semibold text-text-primary">{entry.frontmatter.version}</span>
                  <span class="text-sm text-text-muted">{formatDate(entry.frontmatter.date)}</span>
                  {entry.frontmatter.label && (
                    <span class="rounded-full bg-accent/10 px-2.5 py-0.5 text-xs font-medium text-accent">
                      {entry.frontmatter.label}
                    </span>
                  )}
                </div>
                {entry.frontmatter.title && (
                  <p class="mt-1 text-sm text-text-secondary">{entry.frontmatter.title}</p>
                )}
                <div class="changelog-body mt-4 text-sm text-text-secondary">
                  <entry.Content />
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<style is:global>
  .changelog-body h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    margin-top: 1.25rem;
  }
  .changelog-body h3:first-child {
    margin-top: 0;
  }
  .changelog-body h3::before {
    content: '';
    flex-shrink: 0;
    width: 1.25rem;
    height: 1.25rem;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }

  /* New Features — green + icon */
  .changelog-body h3#new-features {
    color: #4ade80;
  }
  .changelog-body h3#new-features::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234ade80' stroke-width='2.5' stroke-linecap='round'%3E%3Cpath d='M12 5v14M5 12h14'/%3E%3C/svg%3E");
  }

  /* Improvements — blue wrench icon */
  .changelog-body h3#improvements {
    color: #60a5fa;
  }
  .changelog-body h3#improvements::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2360a5fa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z'/%3E%3C/svg%3E");
  }

  /* Bug Fixes — red bug icon */
  .changelog-body h3#bug-fixes {
    color: #f87171;
  }
  .changelog-body h3#bug-fixes::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f87171' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m8 2 1.88 1.88M14.12 3.88 16 2M9 7.13v-1a3.003 3.003 0 1 1 6 0v1'/%3E%3Cpath d='M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6'/%3E%3Cpath d='M12 20v-9M6.53 9C4.6 8.8 3 7.1 3 5M6 13H2M3 21c0-2.1 1.7-3.9 3.8-4M20.97 5c0 2.1-1.6 3.8-3.5 4M22 13h-4M17.2 17c2.1.1 3.8 1.9 3.8 4'/%3E%3C/svg%3E");
  }

  /* Fallback for unrecognized h3s */
  .changelog-body h3:not(#new-features):not(#improvements):not(#bug-fixes) {
    color: var(--color-text-primary);
  }
  .changelog-body h3:not(#new-features):not(#improvements):not(#bug-fixes)::before {
    display: none;
  }

  .changelog-body ul {
    list-style: disc;
    padding-left: 1.25rem;
    margin-bottom: 0.5rem;
  }
  .changelog-body li {
    margin-bottom: 0.25rem;
  }
</style>
